name: Deploy Backend

on:
  push:
    branches:
      - main
      - feature/*
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - prod
          - test

jobs:
  deploy-prod:
    if: github.event_name == 'push' || inputs.environment == 'prod'
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Load backend configuration
        id: config
        run: |
          CONFIG=$(cat config/environments.json | jq -r '.prod.backend')
          DB_CONFIG=$(cat config/environments.json | jq -r '.prod.database')
          
          # Backend config
          echo "network=$(echo $CONFIG | jq -r '.network')" >> $GITHUB_OUTPUT
          echo "container=$(echo $CONFIG | jq -r '.container')" >> $GITHUB_OUTPUT
          echo "image_name=$(echo $CONFIG | jq -r '.image_name')" >> $GITHUB_OUTPUT
          echo "image_tag=$(echo $CONFIG | jq -r '.image_tag')" >> $GITHUB_OUTPUT
          echo "port_http=$(echo $CONFIG | jq -r '.port_http')" >> $GITHUB_OUTPUT
          echo "port_https=$(echo $CONFIG | jq -r '.port_https')" >> $GITHUB_OUTPUT
          echo "ssl_enabled=$(echo $CONFIG | jq -r '.ssl_enabled')" >> $GITHUB_OUTPUT
          echo "sso_enabled=$(echo $CONFIG | jq -r '.sso_enabled')" >> $GITHUB_OUTPUT
          echo "db_host=$(echo $CONFIG | jq -r '.db_host')" >> $GITHUB_OUTPUT
          echo "db_port=$(echo $CONFIG | jq -r '.db_port')" >> $GITHUB_OUTPUT
          echo "health_check_url=$(echo $CONFIG | jq -r '.health_check_url')" >> $GITHUB_OUTPUT
          
          # Volume names
          echo "pki_volume=$(echo $CONFIG | jq -r '.volumes.pki_data')" >> $GITHUB_OUTPUT
          
          # Database config
          echo "db_name=$(echo $DB_CONFIG | jq -r '.db_name')" >> $GITHUB_OUTPUT
          echo "db_user=$(echo $DB_CONFIG | jq -r '.db_user')" >> $GITHUB_OUTPUT
      - name: Ensure network exists
        uses: ./.github/actions/docker-network
        with:
          network-name: ${{ steps.config.outputs.network }}

      - name: Build and Deploy Backend
        uses: ./.github/actions/docker-build-deploy
        with:
          container-name: ${{ steps.config.outputs.container }}
          network-name: ${{ steps.config.outputs.network }}
          dockerfile-path: 'backend/Dockerfile'
          build-context: 'backend'
          image-name: ${{ steps.config.outputs.image_name }}
          image-tag: ${{ steps.config.outputs.image_tag }}
          exposed-ports: '${{ steps.config.outputs.port_http }}:8888,${{ steps.config.outputs.port_https }}:8443'
          environment-vars: 'SSL=${{ steps.config.outputs.ssl_enabled }},SSO=${{ steps.config.outputs.sso_enabled }},DB_HOST=${{ steps.config.outputs.db_host }},DB_PORT=${{ steps.config.outputs.db_port }},DB_NAME=${{ steps.config.outputs.db_name }},DB_USER=${{ steps.config.outputs.db_user }},DB_PASSWORD=${{ secrets.PROD_DB_PASSWORD }}'
          volumes: '${{ steps.config.outputs.pki_volume }}:/etc/pki'
          named-volumes: '${{ steps.config.outputs.pki_volume }}'
          health-check-url: '${{ steps.config.outputs.health_check_url }}'
          depends-on: '${{ steps.config.outputs.db_host }}'

      - name: Verify deployment
        run: |
          echo "=== Backend Deployed (Production) ==="
          docker ps --filter name=${{ steps.config.outputs.container }} \
            --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "Volumes:"
          docker volume ls | grep -E "${{ steps.config.outputs.pki_volume }}"
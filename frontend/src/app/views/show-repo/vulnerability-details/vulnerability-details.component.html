<c-offcanvas placement="end" [visible]="detailsModal" (visibleChange)="handleDetailsModal($event)"
    class="vulnerability-details-offcanvas">
    <c-offcanvas-header>
        <div class="d-flex align-items-center justify-content-between w-100">
            <h5 cOffcanvasTitle class="mb-0">Vulnerability Details</h5>

            <div class="d-flex align-items-center gap-2">
                <!-- Suppress Controls in Header -->
                <div *ngIf="singleVuln?.vulnsResponseDto?.status != 'SUPRESSED'" class="d-flex align-items-center">
                    <ng-container *ngIf="!showSuppressForm; else suppressForm">
                        <button cButton color="warning" variant="outline" size="sm" (click)="showSuppressForm = true">
                            <svg cIcon name="cil-volume-off" class="me-1"></svg>
                            Suppress
                        </button>
                    </ng-container>
                    <ng-template #suppressForm>
                        <div class="d-flex align-items-center suppress-form-container rounded p-1 border">
                            <select class="form-select form-select-sm me-2" [(ngModel)]="suppressReason"
                                style="width: 150px;">
                                <option value="" disabled selected>Reason...</option>
                                <option *ngFor="let reason of suppressReasons" [value]="reason">{{ reason }}</option>
                            </select>
                            <button cButton color="warning" size="sm" class="me-1" (click)="suppressFinding()"
                                [disabled]="!suppressReason">
                                Confirm
                            </button>
                            <button cButton color="secondary" variant="ghost" size="sm"
                                (click)="showSuppressForm = false">
                                <svg cIcon name="cil-x"></svg>
                            </button>
                        </div>
                    </ng-template>
                </div>

                <button *ngIf="singleVuln?.vulnsResponseDto?.status == 'SUPRESSED'" cButton color="success" size="sm"
                    (click)="reactivateFinding()">
                    <svg cIcon name="cil-volume-high" class="me-1"></svg>
                    Re-Activate
                </button>

                <button class="btn-close-custom ms-3" (click)="closeModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </c-offcanvas-header>
    <c-offcanvas-body class="flex-grow-1 overflow-auto">
        <div class="scrollable-content" *ngIf="selectedRowId !== null">
            <!-- Debug Control (Temporary) -->
            <div class="mb-3 p-2 border rounded bg-light d-flex align-items-center justify-content-between">
                <small class="text-muted fw-bold">Debug Reachability:</small>
                <select class="form-select form-select-sm w-auto" [(ngModel)]="debugReachabilityScore"
                    (change)="useDebugScore = true">
                    <option [ngValue]="null">Unknown (Default)</option>
                    <option [ngValue]="0.1">Spaghetti (< 0.3)</option>
                    <option [ngValue]="0.4">2 Checkpoints (0.3 - 0.6)</option>
                    <option [ngValue]="0.7">1 Checkpoint (0.6 - 0.9)</option>
                    <option [ngValue]="0.95">Straight (> 0.9)</option>
                </select>
                <button cButton size="sm" color="secondary" variant="ghost"
                    (click)="useDebugScore = false; debugReachabilityScore = null">Reset</button>
            </div>

            <!-- Reachability Graph -->
            <app-reachability-graph
                [score]="useDebugScore ? debugReachabilityScore : (singleVuln?.vulnsResponseDto?.predictedProbability || singleVuln?.predictedProbability)">
            </app-reachability-graph>

            <!-- Info Section (Card Layout) -->
            <!-- Compact Header Info -->
            <c-card class="mb-4">
                <c-card-header>
                    <h6 class="mb-0">{{ singleVuln?.vulnsResponseDto?.name }}</h6>
                </c-card-header>
                <c-card-body>
                    <c-row>
                        <c-col [md]="6" class="mb-2">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2 text-muted small">SEVERITY</span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'HIGH'" class="dot high"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'MEDIUM'"
                                    class="dot medium"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'LOW'" class="dot low"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'INFO'" class="dot low"></span>
                                <c-spinner *ngIf="singleVuln?.vulnsResponseDto?.severity === 'CRITICAL'" color="danger"
                                    variant="grow" size="sm"></c-spinner>
                                <span class="ms-2 fw-bold" [ngClass]="{
                                    'text-danger': singleVuln?.vulnsResponseDto?.severity === 'CRITICAL',
                                    'text-warning': singleVuln?.vulnsResponseDto?.severity === 'HIGH',
                                    'text-info': singleVuln?.vulnsResponseDto?.severity === 'MEDIUM',
                                    'text-success': singleVuln?.vulnsResponseDto?.severity === 'LOW' || singleVuln?.vulnsResponseDto?.severity === 'INFO'
                                }">{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                            </div>
                        </c-col>
                        <c-col [md]="6" class="mb-2">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2 text-muted small">STATUS</span>
                                <svg cIcon
                                    [name]="singleVuln?.vulnsResponseDto?.status === 'NEW' ? 'cil-burn' : singleVuln?.vulnsResponseDto?.status === 'EXISTING' ? 'cil-graph' : singleVuln?.vulnsResponseDto?.status === 'REMOVED' ? 'cil-trash' : 'cil-volume-off'"
                                    class="me-2"></svg>
                                <span>{{ singleVuln?.vulnsResponseDto?.status }}</span>
                            </div>
                        </c-col>
                        <c-col [md]="12" class="mb-2">
                            <div class="d-flex align-items-center location-container">
                                <span class="fw-bold me-2 text-muted small">LOCATION</span>
                                <ng-container
                                    *ngIf="isLinkableSource(singleVuln?.vulnsResponseDto?.source); else plainTextLocation">
                                    <a [href]="getRepositoryLink()" target="_blank"
                                        class="text-primary d-flex align-items-center">
                                        <svg *ngIf="singleVuln?.vulnsResponseDto?.source !== 'DAST'" cIcon
                                            name="cib-git" class="me-2"></svg>
                                        <svg *ngIf="singleVuln?.vulnsResponseDto?.source === 'DAST'" cIcon
                                            name="cil-link" class="me-2"></svg>
                                        <span>{{ getFormattedLocation() }}</span>
                                        <svg cIcon name="cil-external-link" class="ms-1" size="sm"></svg>
                                    </a>
                                </ng-container>
                                <ng-template #plainTextLocation>
                                    <span>{{ getFormattedLocation() }}</span>
                                </ng-template>
                            </div>
                        </c-col>
                        <c-col [md]="6">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2 text-muted small">DETECTED</span>
                                <span>{{ singleVuln?.vulnsResponseDto?.inserted | date:'mediumDate' }}</span>
                            </div>
                        </c-col>
                        <c-col [md]="6">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2 text-muted small">LAST SEEN</span>
                                <span>{{ singleVuln?.vulnsResponseDto?.last_seen | date:'mediumDate' }}</span>
                            </div>
                        </c-col>
                    </c-row>
                </c-card-body>
            </c-card>
        </div>

        <!-- Vertical Tabs Section -->
        <div class="d-flex flex-grow-1 overflow-hidden">
            <c-tabs [activeItemKey]="0" *ngIf="singleVuln" class="d-flex w-100 h-100">
                <!-- Tab List (Sidebar) -->
                <c-tabs-list variant="pills" class="flex-column border-end bg-light h-100 p-2"
                    style="width: 200px; flex-shrink: 0; overflow-y: auto;">
                    <button cTab [itemKey]="0" class="w-100 text-start mb-1 justify-content-start">
                        <svg cIcon name="cil-notes" class="me-2"></svg>
                        Description
                    </button>
                    <button cTab [itemKey]="1" class="w-100 text-start mb-1 justify-content-start">
                        <svg cIcon name="cil-lightbulb" class="me-2"></svg>
                        Recommendation
                    </button>
                    <button cTab [itemKey]="2" class="w-100 text-start mb-1 justify-content-start">
                        <svg cIcon name="cil-description" class="me-2"></svg>
                        Explanation
                    </button>
                    <button cTab [itemKey]="3" class="w-100 text-start mb-1 justify-content-start">
                        <svg cIcon name="cil-link" class="me-2"></svg>
                        References
                    </button>
                    <button cTab [itemKey]="4" class="w-100 text-start mb-1 justify-content-start">
                        <svg cIcon name="cil-comment-square" class="me-2"></svg>
                        Comments
                        <c-badge *ngIf="singleVuln?.comments?.length" color="info" class="ms-auto">
                            {{ singleVuln.comments.length }}
                        </c-badge>
                    </button>
                </c-tabs-list>

                <!-- Tab Content (Scrollable Area) -->
                <c-tabs-content class="flex-grow-1 h-100 overflow-auto bg-body">
                    <c-tab-panel class="p-4" [itemKey]="0" *ngIf="singleVuln">
                        <markdown [data]="singleVuln.description || 'No description available at this moment'">
                        </markdown>
                    </c-tab-panel>
                    <c-tab-panel class="p-4" [itemKey]="1" *ngIf="singleVuln">
                        <markdown [data]="singleVuln.recommendation || 'No recommendation available at this moment'">
                        </markdown>
                    </c-tab-panel>
                    <c-tab-panel class="p-4" [itemKey]="2" *ngIf="singleVuln">
                        <markdown [data]="singleVuln.explanation || 'No explanation available at this moment'">
                        </markdown>
                    </c-tab-panel>
                    <c-tab-panel class="p-4" [itemKey]="3" *ngIf="singleVuln">
                        <markdown [data]="singleVuln.refs || 'No references available at this moment'"></markdown>
                    </c-tab-panel>

                    <c-tab-panel class="p-4" [itemKey]="4" *ngIf="singleVuln">
                        <div *ngIf="!singleVuln?.comments?.length" class="text-center text-muted my-4">
                            <svg cIcon name="cil-comment-square" width="32" height="32" class="mb-2 text-muted"></svg>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>

                        <div class="comments-container">
                            <div *ngFor="let comment of singleVuln?.comments"
                                class="comment-item mb-3 pb-3 border-bottom">
                                <div class="d-flex">
                                    <div class="comment-avatar">
                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                            style="width: 40px; height: 40px;">
                                            {{ comment.author.charAt(0).toUpperCase() }}
                                        </div>
                                    </div>
                                    <div class="ms-3 flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>{{ comment.author }}</strong>
                                            <small class="text-muted">{{ comment.inserted | date:'medium' }}</small>
                                        </div>
                                        <div class="comment-content mt-1 p-2 bg-light rounded">
                                            {{ comment.message }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <form (ngSubmit)="addComment()" class="d-flex">
                                <input type="text" class="form-control me-2" [(ngModel)]="newComment" name="newComment"
                                    placeholder="Type your comment..." [disabled]="isAddingComment"
                                    (ngModelChange)="onNewCommentChange($event)" required>
                                <button cButton color="primary" type="submit"
                                    [disabled]="!newComment.trim() || isAddingComment">
                                    <c-spinner *ngIf="isAddingComment" size="sm" class="me-1"></c-spinner>
                                    Send
                                </button>
                            </form>
                        </div>
                    </c-tab-panel>
                </c-tabs-content>
            </c-tabs>
        </div>

        <!-- Actions Footer -->
        <div class="mt-4 pt-3 border-top">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button (click)="reactivateFinding()" *ngIf="singleVuln?.vulnsResponseDto?.status == 'SUPRESSED'"
                        cButton color="success">
                        <svg cIcon name="cil-volume-high" class="me-1"></svg>
                        Re-Activate Finding
                    </button>
                </div>
            </div>
        </div>
    </c-offcanvas-body>
</c-offcanvas>
<c-modal size="xl" id="detailsModal" alignment="center" [visible]="detailsModal" (visibleChange)="handleDetailsModal($event)">
    <c-modal-header>
        <h5 cModalTitle class="vuln-modal-title">Vulnerability Details</h5>
    </c-modal-header>
    <c-modal-body>
        <div *ngIf="selectedRowId !== null" class="vuln-details-container">
            <!-- Header Section with Vulnerability Overview -->
            <div class="vuln-header mb-4">
                <div class="vuln-title-container mb-3">
                    <h4 class="vuln-name">{{ singleVuln?.vulnsResponseDto?.name }}</h4>

                    <div class="vuln-severity">
                        <div [ngClass]="'severity-badge severity-' + singleVuln?.vulnsResponseDto?.severity?.toLowerCase()">
                            <span *ngIf="singleVuln?.vulnsResponseDto?.severity !== 'CRITICAL'" class="severity-dot"></span>
                            <c-spinner *ngIf="singleVuln?.vulnsResponseDto?.severity === 'CRITICAL'" color="danger" variant="grow" size="sm"></c-spinner>
                            {{ singleVuln?.vulnsResponseDto?.severity }}
                        </div>
                    </div>
                </div>

                <div class="vuln-meta-container">
                    <div class="vuln-meta-row">
                        <div class="vuln-meta-item location">
                            <span class="meta-label">Location</span>
                            <div class="meta-content">
                                <a [href]="getRepositoryLink()" target="_blank" class="location-link">
                                    <svg cIcon name="cib-git" class="location-icon"></svg>
                                    <span class="location-text">{{ getFormattedLocation() }}</span>
                                    <svg cIcon name="cil-external-link" class="external-link-icon" size="sm"></svg>
                                </a>
                            </div>
                        </div>

                        <div class="vuln-meta-item status">
                            <span class="meta-label">Status</span>
                            <div class="meta-content">
                                <div [ngClass]="'status-badge status-' + singleVuln?.vulnsResponseDto?.status?.toLowerCase()">
                                    <svg
                                            cIcon
                                            [name]="
                                            singleVuln?.vulnsResponseDto?.status === 'NEW' ? 'cil-burn' :
                                            singleVuln?.vulnsResponseDto?.status === 'EXISTING' ? 'cil-graph' :
                                            singleVuln?.vulnsResponseDto?.status === 'REMOVED' ? 'cil-trash' : 'cil-volume-off'
                                        "
                                            class="status-icon"
                                    ></svg>
                                    {{ singleVuln?.vulnsResponseDto?.status }}
                                </div>
                            </div>
                        </div>

                        <div class="vuln-meta-item timeline">
                            <span class="meta-label">Timeline</span>
                            <div class="meta-content">
                                <div class="timeline-dates">
                                    <div class="date-item">
                                        <span class="date-label">Detected:</span>
                                        <span class="date-value">{{ singleVuln?.vulnsResponseDto?.inserted | date }}</span>
                                    </div>
                                    <div class="date-item">
                                        <span class="date-label">Last Seen:</span>
                                        <span class="date-value">{{ singleVuln?.vulnsResponseDto?.last_seen | date }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Section for Details -->
            <div class="vuln-details-tabs">
                <c-tabs [activeItemKey]="0" *ngIf="singleVuln" variant="pills" class="details-tabs">
                    <c-tabs-list class="mb-3">
                        <button cTab [itemKey]="0" class="tab-btn">
                            <svg cIcon name="cil-description" class="tab-icon"></svg>
                            Description
                        </button>
                        <button cTab [itemKey]="1" class="tab-btn">
                            <svg cIcon name="cil-lightbulb" class="tab-icon"></svg>
                            Recommendation
                        </button>
                        <button cTab [itemKey]="2" class="tab-btn">
                            <svg cIcon name="cil-notes" class="tab-icon"></svg>
                            Explanation
                        </button>
                        <button cTab [itemKey]="3" class="tab-btn">
                            <svg cIcon name="cil-link" class="tab-icon"></svg>
                            References
                        </button>
                        <button cTab [itemKey]="4" class="tab-btn">
                            <svg cIcon name="cil-comment-square" class="tab-icon"></svg>
                            Comments
                            <c-badge *ngIf="singleVuln?.comments?.length" color="info" shape="rounded-pill" class="ms-1 comments-badge">
                                {{ singleVuln.comments.length }}
                            </c-badge>
                        </button>
                    </c-tabs-list>
                    <c-tabs-content>
                        <!-- Description Tab -->
                        <c-tab-panel class="tab-content" [itemKey]="0" *ngIf="singleVuln">
                            <div class="markdown-wrapper">
                                <markdown [data]="singleVuln.description || 'No description available at this moment'" class="markdown-content"></markdown>
                            </div>
                        </c-tab-panel>

                        <!-- Recommendation Tab -->
                        <c-tab-panel class="tab-content" [itemKey]="1" *ngIf="singleVuln">
                            <div class="markdown-wrapper">
                                <markdown [data]="singleVuln.recommendation || 'No recommendation available at this moment'" class="markdown-content"></markdown>
                            </div>
                        </c-tab-panel>

                        <!-- Explanation Tab -->
                        <c-tab-panel class="tab-content" [itemKey]="2" *ngIf="singleVuln">
                            <div class="markdown-wrapper">
                                <markdown [data]="singleVuln.explanation || 'No explanation available at this moment'" class="markdown-content"></markdown>
                            </div>
                        </c-tab-panel>

                        <!-- References Tab -->
                        <c-tab-panel class="tab-content" [itemKey]="3" *ngIf="singleVuln">
                            <div class="markdown-wrapper">
                                <markdown [data]="singleVuln.refs || 'No references available at this moment'" class="markdown-content"></markdown>
                            </div>
                        </c-tab-panel>

                        <!-- Comments Tab -->
                        <c-tab-panel class="tab-content" [itemKey]="4" *ngIf="singleVuln">
                            <div class="comments-section">
                                <!-- No comments message -->
                                <div *ngIf="!singleVuln?.comments?.length" class="no-comments">
                                    <svg cIcon name="cil-speech" width="32" height="32"></svg>
                                    <p>No comments yet. Be the first to comment!</p>
                                </div>

                                <!-- Comments list -->
                                <div class="comments-container">
                                    <div *ngFor="let comment of singleVuln?.comments" class="comment-item">
                                        <div class="comment-header">
                                            <div class="comment-author">
                                                <div class="author-avatar">
                                                    {{ comment.author.charAt(0).toUpperCase() }}
                                                </div>
                                                <span class="author-name">{{ comment.author }}</span>
                                            </div>
                                            <div class="comment-date">
                                                {{ comment.inserted | date:'medium' }}
                                            </div>
                                        </div>
                                        <div class="comment-body">
                                            {{ comment.message }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Comment input -->
                                <div class="comment-form-container">
                                    <form (ngSubmit)="addComment()" class="comment-form">
                                        <div class="input-wrapper">
                                            <input
                                                    type="text"
                                                    class="form-control comment-input"
                                                    [(ngModel)]="newComment"
                                                    name="newComment"
                                                    placeholder="Type your comment..."
                                                    [disabled]="isAddingComment"
                                                    (ngModelChange)="onNewCommentChange($event)"
                                                    required
                                            >
                                        </div>
                                        <button
                                                cButton
                                                color="primary"
                                                type="submit"
                                                class="comment-submit"
                                                [disabled]="!newComment.trim() || isAddingComment"
                                        >
                                            <c-spinner *ngIf="isAddingComment" size="sm" class="me-1"></c-spinner>
                                            <span>Send</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </c-tab-panel>
                    </c-tabs-content>
                </c-tabs>
            </div>
        </div>
    </c-modal-body>

    <!-- Action Buttons Section -->
    <c-modal-footer>
        <div class="action-footer">
            <div class="suppress-action">
                <form *ngIf="singleVuln?.vulnsResponseDto?.status != 'SUPRESSED'" class="suppress-form" (ngSubmit)="suppressFinding()">
                    <div class="suppress-label">Suppress finding:</div>
                    <div class="suppress-input">
                        <select
                                id="suppressReason"
                                class="form-select suppress-reason"
                                [(ngModel)]="suppressReason"
                                name="suppressReason"
                                required
                        >
                            <option value="" disabled selected>Select a reason</option>
                            <option *ngFor="let reason of suppressReasons" [value]="reason">{{ reason }}</option>
                        </select>
                    </div>
                    <button
                            type="submit"
                            cButton
                            color="warning"
                            class="suppress-btn"
                            [disabled]="!suppressReason"
                    >
                        <svg cIcon name="cil-volume-off" class="me-1"></svg>
                        Suppress
                    </button>
                </form>

                <button
                        *ngIf="singleVuln?.vulnsResponseDto?.status == 'SUPRESSED'"
                        cButton
                        color="success"
                        class="reactivate-btn"
                        (click)="reactivateFinding()"
                >
                    <svg cIcon name="cil-volume-high" class="me-1"></svg>
                    Re-Activate Finding
                </button>
            </div>

            <button
                    cButton
                    color="secondary"
                    class="close-btn"
                    (click)="closeModal()"
            >
                Close
            </button>
        </div>
    </c-modal-footer>
</c-modal>
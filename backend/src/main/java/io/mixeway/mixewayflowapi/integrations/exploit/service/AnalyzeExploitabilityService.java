package io.mixeway.mixewayflowapi.integrations.exploit.service;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.mixeway.mixewayflowapi.integrations.exploit.model.AnalysisResult;
import lombok.extern.log4j.Log4j2;
import org.springframework.stereotype.Service;

import java.io.*;
import java.nio.file.*;
import java.util.List;

@Service
@Log4j2
public class AnalyzeExploitabilityService {

    public void analyzeRepository(String repoName) throws IOException, InterruptedException {
        log.info("Starting analysis of the repository {}", repoName);

        executeAnalysis("data" + File.separator + repoName + ".zip",
                "data" + File.separator + repoName + ".xlsx");

        processResults("results" + File.separator + repoName + File.separator + repoName + ".json");
    }

    private List<AnalysisResult> processResults(String resultsPath) throws IOException {
        ObjectMapper objectMapper = new ObjectMapper();

        String fullPath = System.getProperty("user.dir")
                + "/volnerability-check-main/" + resultsPath;

        List<AnalysisResult> result;
        try (InputStream inputStream = Files.newInputStream(Paths.get(fullPath))) {
            result = objectMapper.readValue(inputStream, new TypeReference<>() {});
        }

        return result;
    }

    private static String executeAnalysis(String repoPath, String vulnerabilitiesExcelPath) throws IOException, InterruptedException {
        // Project root
        File projectRoot = new File(System.getProperty("user.dir"), "volnerability-check-main");

        // Detect OS â†’ choose correct venv Python path
        String osName = System.getProperty("os.name").toLowerCase();
        String venvPython = getPython(osName, projectRoot);

        ProcessBuilder pb = new ProcessBuilder(
                venvPython,
                "-m", "src",
                "analyze", repoPath, vulnerabilitiesExcelPath
        );
        pb.directory(projectRoot);
        pb.environment().put("PYTHONUTF8", "1");
        pb.redirectErrorStream(true);

        // Start the process
        Process process = pb.start();

        // Capture output in real-time
        StringBuilder output = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(
                new InputStreamReader(process.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
                System.out.println(line); // Optional: log in real-time
            }
        }

        int exitCode = process.waitFor();
        if (exitCode != 0) {
            throw new RuntimeException("Execution failed with code " + exitCode + "\n" + output);
        }

        return output.toString();
    }

    private static String getPython(String osName, File projectRoot) {
        String pythonRelative;
        if (osName.contains("win")) {
            pythonRelative = ".venv" + File.separator + "Scripts" + File.separator + "python.exe";
        } else {
            pythonRelative = ".venv" + File.separator + "bin" + File.separator + "python";
        }

        File pythonExe = new File(projectRoot, pythonRelative);
        String venvPython = pythonExe.getAbsolutePath();

        if (!pythonExe.exists()) {
            throw new IllegalStateException("Python executable not found: " + venvPython);
        }
        return venvPython;
    }
}

package io.mixeway.mixewayflowapi.modules.exploit.api.controller;

import io.mixeway.mixewayflowapi.modules.exploit.api.events.AnalyzeExploitabilityEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
@Log4j2
public class ExploitabilityController {

    private final ApplicationEventPublisher publisher;

    @GetMapping(value= "/api/v1/exploitability/analyzeRepository")
    public ResponseEntity<String> analyzeRepository(@RequestParam long repoId){
        if (repoId == 0)
            return ResponseEntity.badRequest().body("Repo Id cannot be 0");
        if (repoId < 0)
            return ResponseEntity.badRequest().body("Repo Id cannot lower than 0");

        AnalyzeExploitabilityEvent analyzeExploitabilityEvent = new AnalyzeExploitabilityEvent(repoId);
        publisher.publishEvent(analyzeExploitabilityEvent);

        return ResponseEntity.ok("Analysis has started");
    }
}

package io.mixeway.mixewayflowapi.modules.exploit.api.controller;

import io.mixeway.mixewayflowapi.modules.exploit.api.events.AnalyzeExploitabilityEvent;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.ActiveProfiles;

import static org.assertj.core.api.AssertionsForClassTypes.assertThat;
import static org.mockito.Mockito.*;

@SpringBootTest
@ActiveProfiles("ut")
public class ExploitabilityControllerTest {

    private ApplicationEventPublisher publisher;
    private ExploitabilityController controller;

    @BeforeEach
    void setUp() {
        publisher = mock(ApplicationEventPublisher.class);
        controller = new ExploitabilityController(publisher);
    }

    @Test
    void analyzeRepository_shouldPublishEvent_andReturnOkResponse() {
        // given
        long repoId = 42L;
        ArgumentCaptor<AnalyzeExploitabilityEvent> eventCaptor =
                ArgumentCaptor.forClass(AnalyzeExploitabilityEvent.class);

        // when
        ResponseEntity<String> response = controller.analyzeRepository(repoId);

        // then
        verify(publisher, times(1)).publishEvent(eventCaptor.capture());
        AnalyzeExploitabilityEvent publishedEvent = eventCaptor.getValue();

        assertThat(publishedEvent).isNotNull();
        assertThat(publishedEvent.getRepositoryId()).isEqualTo(repoId);

        assertThat(response.getStatusCode().is2xxSuccessful()).isEqualTo(true);
        assertThat(response.getBody()).isEqualTo("Analysis has started");
    }

    @Test
    void analyzeRepository_shouldHandleDifferentRepoIds() {
        // given
        long repoId = 123L;

        // when
        controller.analyzeRepository(repoId);

        // then
        verify(publisher).publishEvent(argThat(event ->
                event instanceof AnalyzeExploitabilityEvent &&
                        ((AnalyzeExploitabilityEvent) event).getRepositoryId() == repoId
        ));
    }

    @Test
    void analyzeRepository_zeroInput_shouldNotPublishEvent_andReturnBadRequestResponse() {
        // given
        long repoId = 0L;
        ArgumentCaptor<AnalyzeExploitabilityEvent> eventCaptor =
                ArgumentCaptor.forClass(AnalyzeExploitabilityEvent.class);

        // when
        ResponseEntity<String> response = controller.analyzeRepository(repoId);

        // then
        verify(publisher, times(0)).publishEvent(eventCaptor.capture());

        assertThat(response.getStatusCode().is4xxClientError()).isEqualTo(true);
        assertThat(response.getBody()).isEqualTo("Repo Id cannot be 0");
    }

    @Test
    void analyzeRepository_negativeInput_shouldNotPublishEvent_andReturnBadRequestResponse() {
        // given
        long repoId = -20L;
        ArgumentCaptor<AnalyzeExploitabilityEvent> eventCaptor =
                ArgumentCaptor.forClass(AnalyzeExploitabilityEvent.class);

        // when
        ResponseEntity<String> response = controller.analyzeRepository(repoId);

        // then
        verify(publisher, times(0)).publishEvent(eventCaptor.capture());

        assertThat(response.getStatusCode().is4xxClientError()).isEqualTo(true);
        assertThat(response.getBody()).isEqualTo("Repo Id cannot lower than 0");
    }
}
